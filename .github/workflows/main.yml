name: Update Language Chart
permissions:
  contents: write
on:
  schedule:
    - cron: "0 */6 * * *" # every 6 hours
  workflow_dispatch:      # allow manual run

jobs:
  update-readme:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Call ZIIT API (via Cloudflare Worker)
        run: |
          curl -s "https://ziit-request.roganmoffat.workers.dev?timeRange=month&midnightOffsetSeconds=0" \
            -o ziit.json

      - name: Debug ZIIT response
        run: cat ziit.json
      - name: Generate Language Chart SVG
        run: |
          LANG_DATA=$(jq -r '[.summaries[].languages] | add | to_entries | sort_by(.value) | reverse' ziit.json)
          TOTAL=$(echo "$LANG_DATA" | jq '[.[].value] | add')
          
          # Calculate height dynamically
          ITEM_COUNT=$(echo "$LANG_DATA" | jq 'length')
          HEIGHT=$((ITEM_COUNT * 35 + 40))
          
          # SVG Header with dynamic height
          cat > chart.svg << 'EOF'
          <svg width="700" height="HEIGHT_PLACEHOLDER" viewBox="0 0 700 HEIGHT_PLACEHOLDER" xmlns="http://www.w3.org/2000/svg">
            <defs>
              <linearGradient id="grad" x1="0%" y1="0%" x2="100%" y2="0%">
                <stop offset="0%" stop-color="#ff6a00"/>
                <stop offset="50%" stop-color="#ff0080"/>
                <stop offset="100%" stop-color="#ee0979"/>
              </linearGradient>
            </defs>
            <style>
              text { fill: #c72a2aff; font-family: 'Segoe UI', monospace; font-size: 14px; }
              .lang-name { font-weight: 600; }
              .percentage { fill: #f1851fff; font-size: 12px; }
              .bar { 
                rx: 7; 
                ry: 7; 
                opacity: 0;
                animation: slideIn 0.8s ease-out forwards;
              }
              @keyframes slideIn {
                0% { 
                  opacity: 0;
                  transform: scaleX(0) translateX(-10px);
                }
                100% { 
                  opacity: 1;
                  transform: scaleX(1) translateX(0);
                }
              }
            </style>
          EOF
          
          # Replace height placeholder
          sed -i "s/HEIGHT_PLACEHOLDER/$HEIGHT/g" chart.svg
          
          Y=30
          INDEX=0
          MAX_BAR_WIDTH=450
          
          echo "$LANG_DATA" | jq -c '.[]' | while read item; do
            NAME=$(echo "$item" | jq -r '.key')
            SEC=$(echo "$item" | jq -r '.value')
            PCT=$(echo "scale=2; ($SEC/$TOTAL)*100" | bc)
            BAR_WIDTH=$(echo "scale=0; $MAX_BAR_WIDTH * $SEC / $TOTAL" | bc)
            
            # Stagger animation delay
            DELAY=$(echo "scale=2; $INDEX * 0.1" | bc)
            
            # Language name
            echo "<text x='10' y='$Y' class='lang-name'>$NAME</text>" >> chart.svg
            
            # Animated bar with delay
            echo "<rect x='150' y='$((Y-14))' width='$BAR_WIDTH' height='18' class='bar' fill='url(#grad)' style='animation-delay: ${DELAY}s; transform-origin: 150px $((Y-5))px;' />" >> chart.svg
            
            # Percentage text
            echo "<text x='$((150 + BAR_WIDTH + 10))' y='$Y' class='percentage'>${PCT}%</text>" >> chart.svg
            
            Y=$((Y+35))
            INDEX=$((INDEX+1))
          done
          
          echo '</svg>' >> chart.svg

      - name: Update README
        run: |
          awk ' /ZIIT-LANG-CHART-START/ {print; print "<img src=\"chart.svg\" width=\"100%\">"; skip=1; next} /ZIIT-LANG-CHART-END/ {skip=0} !skip' README.md > newREADME
          mv newREADME README.md

      - name: Commit & Push
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: "chore: update language chart"
          branch: main
